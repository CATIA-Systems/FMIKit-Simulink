# FMU Export

The following sections describe how to export FMUs from Simulink models using the Simulink Coder target provided with FMI Kit.

## Introduction

The `rtwsfcnfmi` folder of the FMI Kit distribution contains Simulink Coder files facilitating specialized code generation in order to build FMUs from Simulink models.
The project builds on the Simulink Coder `S-function Target` configuration that is available in MATLAB.
In fact, the same model C code is generated by the `S-function Target with FMI` as for the `S-function target`.

In addition, the FMI target performs the following

- Constructs the model description interface, modelDescription.xml, from the `<modelname>.rtw` model description
- Compiles the generated model code and the S-function FMI wrapper and links with required libraries
- Constructs the FMI zip archive (`*.fmu`) according to the specified structure

## Creating an S-function FMU

If the Simulink model to be exported as an FMU should be integrated (connected) with other components, you need to add external input and/or output ports to your model.
These can be found in the Sinks and Sources categories of the Simulink browser.

![Coder target](images/coder_target.png)

In the Simulink `Configuration Parameters` dialog, choose the `Code Generation` tab and click Browse to select a different System Target File.
Select `rtwsfcnfmi.tlc` in the list.
FMI-specific options then become available in the Code Generation category as `FMI options`:

### FMI version

selects FMI version for the export (1.0 or 2.0)

### FMI type

specifies FMI type (ModelExchange or CoSimulation)

### Zip utility

Zip utility used to build the FMU archive (default: 7-Zip on Windows, zip on Linux)

### Zip options

Command line options passed to the Zip utility

### Model author

specifies model author for FMU XML description

### Generate black-box FMU

selects if the FMU should be generated as a black box (only inputs and outputs)

### Include block hierarchy in variable names

selects if variable names of the FMU XML should use block hierarchy notation

### Include global block outputs

selects if block outputs should be included in FMU XML description

### Include discrete states (DWork)

selects if discrete states and modes should be included in FMU XML description

### Export image (.png) of Simulink model to FMU resources

selects if an image of the Simulink model should be exported with the FMU

### Copy Simulink model to FMU resources

selects if the whole Simulink model should be copied to the FMU

### Load S-functions from binary MEX files

selects that S-functions in the model will be loaded from pre-compiled binary MEX files instead of using stand-alone compilation of S-function sources. This option will create dependencies on MATLAB binaries, which are not included in the exported FMU.

On Windows, the FMU will by default try to load these from the bin directory of the exporting MATLAB installation.
The environment variable `SFCN_FMI_MATLAB_BIN` can be used to specify a different directory from where to load the MATLAB binaries (for example a MATLAB run-time installation).

On Linux, it is required to use the environment variable `LD_LIBRARY_PATH` to specify the path to the MATLAB binaries.

The S-function MEX files used by the model are copied to `/resources/SFunctions` of the FMU and are loaded automatically when the FMU is instantiated.

### Additional S-function sources

List of additional user source files for stand-alone S-function compilation.
Should be used instead of `Custom Code > Source Files` to ensure that the correct compiler options are used

### Compiler optimization flags

User-defined optimization flags to be used by the compiler (default: /O2 /Oy - for Visual Studio on Windows and -O2 for GCC on Linux)

### Settings for Simulink Configuration Parameters > Solver

Model Exchange export: Both Variable-step and Fixed-step solvers supported

- recommended to use Variable-step to support accurate event detection using non-sampled zero-crossings
Co-Simulation export: Requires a Fixed-step solver
- the selected solver is then compiled into the FMU
It is also recommended to set the Tasking mode to SingleTasking
<br>

### Start the Real-time Workshop build process by pressing Ctrl-B.

The build process will compile the generated model code using the FMI Simulink wrapper and link with the required MATLAB and system libraries to create the FMI binary.
The build process will also create the FMI model description (`modelDescription.xml`) and construct the FMU archive (`<modelname>_sf.fmu`) in the current working directory.

The FMI binary is built using the same compiler as used when building the S-function MEX file. This is configured in MATLAB using the command

```
mex -setup
```

## Limitations and Trouble-Shooting

- This version of the package supports 32- and 64-bit MATLAB releases
from R2010a to R2018a.

- On Windows, the package supports Visual Studio 2008 (9.0) and later compilers as supported with the respective MATLAB releases.

- On Linux, the package should support the versions of gcc supported with the respective MATLAB releases.
The object files shipped in the package have all been compiled using gcc 4.5.4

- The FMU is compiled with dynamic loading of the C run-time on Windows.
This may require installation of corresponding Visual Studio redistributables on the target platform.

- The option `Include block hierarchy in variable names` could in very rare cases give rise to name conflicts in the XML variable names.
For example, any special characters in Simulink block names will be converted to underscore which may lead to name conflicts.
It is recommended to avoid using special characters in block names with this option (carriage return and space are safe to use).

- The variable names for continuous-time states, discrete states, parameters, and block outputs are separated in the top-level categories `ContStates`,
`DiscStates`, `Parameters`, and `BlockOutputs` in the structured view.
This is to ensure unique variable names in the FMU XML file, since variable names from different categories are not guaranteed to be unique within a block.
In the flat view, the variable names are appended with `_xc`, `_xd`, `_pm` and `_wb` respectively.

- For multiple instances of conditionally executed non-virtual subsystems or Stateflow charts, it is required to select `Treat as atomic unit` and set `Function packaging` to `Inline` for the subsystems/charts.

- S-functions in the exported model are not allowed to call into the MATLAB environment, e.g. using `mexCallMATLAB` or `mexEvalString`.

- The FMU export target is not model reference compliant.

- The package is subject to the same limitations as the standard S-Function target.


## Included Files

Below follows a short description of the included files

| File                          | Description
|-------------------------------|------------
| `bin`                         | Pre-compiled Visual Studio and GCC binaries of the FMI implementation for the supported MATLAB releases
| `c/fmi`                       | Folder containing the official C headers of the FMI specification
| `c/fmi{1,2}Functions.c`       | Wrapper of Simulink Coder-generated model code for Co-Simulation (FMI 1.0 and 2.0)
| `c/fmi{1,2}Functions_.h`      | Forward declarations for FMI Co-Simulation implementation
| `c/fmi{1,2}ModelFunctions.c`  | Wrapper of Simulink Coder-generated model code for Model Exchange (FMI 1.0 and 2.0)
| `c/fmi{1,2}ModelFunctions_.h` | Forward declarations for Model Exchange implementation
| `m/makeBlockPath.p`           | help utility to construct hierarchical block path for XML file
| `m/makeDateAndDoc.p`          | help utility to make the XML date attribute and copy resources
| `m/makeGUID.mex*`             | MEX file to make a globally unique identifier (GUID) for the XML file
| `m/makeMatlabBin.p`           | help utility to find Matlab bin directory for the current architecture
| `m/makeValueRef.p`            | help utility to construct a value reference
| `m/revert2013b.m`             | to execute revertInlineParametersOffToR2013b in base workspace
| `m/rtwsfcnfmi_init.m`         | m-file to initialize the FMI Kit export target (rtwsfcnfmi)
| `m/rtwsfcnfmi_tmf.m`          | m-file to get the template makefile
| `tlc/ rtwsfcnfmi.tlc`         | Main target language compiler (TLC) script for S-function FMI Target
| `tlc/rtwsfcnfmi_unix.tmf`     | Template makefile for GCC on UNIX-based systems
| `tlc/rtwsfcnfmi_vc.tmf`       | Template makefile for 32-bit Visual Studio compilers
| `tlc/rtwsfcnfmi_vcx64.tmf`    | Template makefile for 64-bit Visual Studio compilers
| `tlc/sfcnfmilib.tlc`          | TLC utility library for the FMU generation
| `tlc/sfcnmdi1.tlc`            | TLC script to build modelDescription.xml for FMI 1.0
| `tlc/sfcnmdi2.tlc`            | TLC script to build modelDescription.xml for FMI 2.0
| `tlc/sfcnmei.tlc`             | TLC script to construct model-specific header
